% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/simulation.R
\name{pq_vectors}
\alias{pq_vectors}
\title{Compute p and q Vectors for Gradient Calculations under a Finite Alleles Model}
\usage{
pq_vectors(
  D,
  hap,
  pairs,
  edge_lengths,
  eigenQ,
  states,
  states_matrix,
  M,
  approx,
  T_prob,
  mu = NULL
)
}
\arguments{
\item{D}{A numeric matrix of dimension \eqn{n \times S}, where \eqn{n} is the number of haplotypes
(tips) and \eqn{S} is the number of sites. Each row corresponds to observed alleles for a haplotype.}

\item{hap}{A list containing:
\describe{
  \item{\code{p}}{Initial \eqn{p}-matrix with leaf initialization.}
  \item{\code{alleles}}{Matrix of observed or possible alleles, each row representing an allele vector.}
}}

\item{pairs}{A matrix where each row corresponds to a pair of child node indices and their parent node index:
\code{c(child1, child2, parent)}.}

\item{edge_lengths}{A numeric vector of edge lengths for the tree (in the same node ordering as `pairs`).}

\item{eigenQ}{A list containing the eigendecomposition of the mutation rate matrix \eqn{Q}:
\code{vectors}, \code{values}, and \code{inv}.}

\item{states}{A named list of possible allele states indexed by string representations.}

\item{states_matrix}{A matrix representation of the possible allele states for faster lookup.}

\item{M}{An integer matrix defining the number of alleles allowed at each site and overlap:
\code{M[i, i]} gives the number of alleles allowed at site \eqn{i} and \code{M[i, j]} gives
the number of alleles for an overlap from site \eqn{i} to \eqn{j}.}

\item{approx}{Integer flag. Set to `0` for exact likelihood mode (all allele combinations
considered), or `1` for approximate likelihood mode (only alleles present in the leaves or wildcard).}

\item{T_prob}{Transition probability matrix (if precomputed), otherwise constructed from `eigenQ`.}

\item{mu}{Optional list structure containing conditional mutation probability distributions for
each overlap. If `NULL`, a uniform distribution over allowed alleles in `M` is assumed.}
}
\value{
A list with three components:
\describe{
  \item{\code{alleles}}{A matrix of all unique alleles encountered, one per row.}
  \item{\code{p}}{An \eqn{A \times (2n - 1)} matrix of forward probabilities.}
  \item{\code{q}}{An \eqn{A \times (2n - 1)} matrix of backward probabilities.}
}
}
\description{
Computes the forward (\eqn{p}) and backward (\eqn{q}) probability vectors for each node
in a phylogenetic tree under a finite-alleles mutation model. The \eqn{p}-vectors represent
the conditional probability of observing all descendant data given a specific allele at a node,
while the \eqn{q}-vectors represent the probability of observing all non-descendant data given
a specific allele at that node. These vectors can be used in gradient-based optimization of
likelihoods.
}
